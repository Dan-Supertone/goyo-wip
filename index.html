<!DOCTYPE html>
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Supertone</title>
<!-- Styles & Scripts -->
<link rel="stylesheet" href="./styles/main.css">
<!-- jQuery -->
<script src="//code.jquery.com/jquery-3.6.0.min.js"></script>

</head>
<body>

<div class="goyo-wrap">
  <div class="goyo-header">
    <button class="play">Play</button>
    <button class="only-voice">Only Voice</button>
    <button class="only-accomp">Only Accomp</button>
    <button class="both">Both</button>
    <button class="change">Change Audio Source</button>
  </div>
</div>

<!--
<h1 class="h1"></h1>
-->

<audio id="audio">
  <source src="./audio/audio-test-accomp.mp3" type="audio/mp3" />
</audio>

<div class="container">
  <div class="player">
    <div class="cover">
      <div class="play-btn">
        <i class="far fa-play-circle fa-4x">start</i>
      </div>
      <div class="img"></div>
    </div>
    <div>
      <div class="progress">
        <div></div>
      </div>
      <span class="percent">0%</span>
    </div>
  </div>

  <div class="knob-container">
    <div class="knob"></div>
  </div>
</div>

</body>
<script>
const audioVoiceA = new Audio();
audioVoiceA.src = "./audio/audio-test-voice.mp3";

const audioAccompA = new Audio();
audioAccompA.src = "./audio/audio-test-accomp.mp3";

const audioVoiceB = new Audio();
audioVoiceB.src = "./audio/audio-2-voice.mp3";

const audioAccompB = new Audio();
audioAccompB.src = "./audio/audio-2-accomp.mp3";

const audioPack = {
  0: [audioVoiceA, audioAccompA],
  1: [audioVoiceB, audioAccompB]
};

const audioCount = Object.keys(audioPack).length - 1;
const buttonPlay = $('button.play');
let isPlaying = false;
let nowPlaying = 0;
$('h1').html(nowPlaying);

//

buttonPlay.click( function () {
  let $this = $(this);
  if (isPlaying == false) {
    play();
    isPlaying = true;
    $this.html('Pause');
    $this.addClass('paused');
  } else {
    pause();
    isPlaying = false;
    $this.html('Play');
    $this.removeClass('paused');
  };
});

$('.only-voice').click( function () {
  audioPack[nowPlaying][0].volume = 1;
  audioPack[nowPlaying][1].volume= 0;
});

$('.only-accomp').click( function () {
  audioPack[nowPlaying][0].volume = 0;
  audioPack[nowPlaying][1].volume = 1;
});

$('.both').click( function () {
  audioPack[nowPlaying][0].volume = 1;
  audioPack[nowPlaying][1].volume = 1;
});

$('.change').click( function () {
  pauseAll();
  if (nowPlaying < audioCount) {
    nowPlaying++;
  } else {
    nowPlaying = 0;
  };
  $('h1').html(nowPlaying);
});

//

function play() {
  audioPack[nowPlaying][0].play();
  audioPack[nowPlaying][1].play();
};

function pause() {
  audioPack[nowPlaying][0].pause();
  audioPack[nowPlaying][1].pause();
};

function pauseAll() {
  for (let i in audioPack) {
    audioPack[i][0].pause();
    audioPack[i][1].pause();
    audioPack[i][0].currentTime = 0;
    audioPack[i][1].currentTime = 0;
  };
  isPlaying = false;
  buttonPlay.html('Play');
  buttonPlay.removeClass('paused');
};



/*
const knob = document.querySelector('.knob');

function calculateDegree(e) {
  const x1 = window.innerWidth / 2;
  const y1 = window.innerHeight / 2;
  const x2 = e.clientX;
  const y2 = e.clientY;

  const deltaX = x1 - x2;
  const deltaY = y1 - y2;

  const rad = Math.atan2(deltaY, deltaX);

  let deg = rad * (180 / Math.PI);

  return deg;
};

knob.addEventListener("mousedown", function () {
  knob.addEventListener("mousemove", rotate);
    function rotate(e) {
      const result = Math.floor(calculateDegree(e) - 90);
      knob.style.transform = `rotate(${result}deg)`;
    }
    knob.addEventListener("mouseup", function () {
      knob.removeEventListener("mousemove", rotate);
    });
});


*/








const knob = document.querySelector(".knob");
const audio = document.querySelector("#audio");
const prog = document.querySelector(".progress > div");
const bar = document.querySelector(".progress");
const pplay = document.querySelector(".play-btn");
const percent = document.querySelector(".percent");

audio.volume = 0.0;

let prevX = 0;
let prevY = 0;

let vol = 0;

barW = bar.clientWidth;

function volumeKnob(e) {
  const w = knob.clientWidth / 2;
  const h = knob.clientHeight / 2;

  const x = e.clientX - knob.offsetLeft;
  const y = e.clientY - knob.offsetTop;

  const deltaX = w - x;
  const deltaY = h - y;

  const rad = Math.atan2(deltaY, deltaX);

  let deg = rad * (180/Math.PI);

  if (y < h && x > w) {
    if (prevX <= x && prevY <= y) {
      vol++;
    }
    else if ( prevX >= x && prevY >= y) {
      vol--;
    }
  }
  else if (y > h && x > w) {
    if (prevX >= x && prevY <= y) {
      vol++;
    }
    else if (prevX <= x && prevY >= y) {
      vol--;
    }
  }
  else if (y < h && x < w) {
    if (prevX <= x && prevY >= y) {
      vol++;
    }
    else if (prevX >= x && prevY <= y) {
      vol--;
    }
  }
  else if (y > h && x < w) {
    if (prevX >= x && prevY >= y) {
      vol++;
    }
    else if (prevX <= x && prevY <= y) {
      vol--;
    }
  }

  const percentage = Math.round((100 * vol) / barW);

  if (vol < 0) {
    vol = 0;
  } else if (vol > barW) {
    vol = barW;
  } else {
    prog.style.width = vol + "px";
    audio.volume = percentage / 100;
    percent.innerText = percentage + "%";
  }

  prevX = x;
  prevY = y;

  return deg;
};


pplay.addEventListener("click", () => {
  audio.play();
  pplay.style.display = "none";
});

function rotate(e) {
  const result = Math.floor(volumeKnob(e) - 80);
  knob.style.transform = `rotate(${result}deg)`;
}

function startRotation() {
  window.addEventListener("mousemove", rotate);
  window.addEventListener("mouseup", endRotation);
}

function endRotation() {
  window.removeEventListener("mousemove", rotate);
}

knob.addEventListener("mousedown", startRotation);

</script>
</html>